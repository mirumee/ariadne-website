<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Dataloaders ¬∑ Ariadne</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;p&gt;Dataloaders are a GraphQL pattern for solving the N+1 problem, where retrieval of &lt;strong&gt;N number of items&lt;/strong&gt; results in &lt;strong&gt;N + 1 number of data retrieval operations&lt;/strong&gt;.&lt;/p&gt;
"/><meta name="docsearch:version" content="0.24"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Dataloaders ¬∑ Ariadne"/><meta property="og:type" content="website"/><meta property="og:url" content="https://ariadnegraphql.org/"/><meta property="og:description" content="&lt;p&gt;Dataloaders are a GraphQL pattern for solving the N+1 problem, where retrieval of &lt;strong&gt;N number of items&lt;/strong&gt; results in &lt;strong&gt;N + 1 number of data retrieval operations&lt;/strong&gt;.&lt;/p&gt;
"/><meta property="og:image" content="https://ariadnegraphql.org/img/share-image.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://ariadnegraphql.org/img/twitter-image.png"/><link rel="shortcut icon" href="/img/favicon.ico"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css"/><link rel="alternate" type="application/atom+xml" href="https://ariadnegraphql.org/blog/atom.xml" title="Ariadne Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://ariadnegraphql.org/blog/feed.xml" title="Ariadne Blog RSS Feed"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-10159761-23', 'auto');
              ga('send', 'pageview');
            </script><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><link rel="stylesheet" href="/css/prism.css"/><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/logo-horizontal.png" alt="Ariadne"/></a><a href="/versions"><h3>0.24</h3></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li><li class="siteNavGroupActive"><a href="/docs/0.24/intro" target="_self">Docs</a></li><li class=""><a href="/blog/" target="_self">Blog</a></li><li class=""><a href="/community" target="_self">Community</a></li><li class=""><a href="https://github.com/mirumee/ariadne" target="_self">GitHub</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>‚Ä∫</i><span>Docs</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Docs</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/0.24/intro">Introduction</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/resolvers">Resolvers</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/mutations">Mutations</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/inputs">Inputs</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/error-messaging">Error messaging</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/case-conversion">Name case conversion</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/fragments">Fragments</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/scalars">Custom scalars</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/enums">Enumeration types</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/unions">Union types</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/interfaces">Interface types</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/subscriptions">Subscriptions</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/0.24/dataloaders">Dataloaders</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/file-uploads">File uploads</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/documenting-schema">Documenting schema</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/modularization">Modularization</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/bindables">Bindables</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/schema-directives">Schema directives</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/local-development">Local development</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/logging">Logging</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/explorers">GraphQL explorers</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/apollo-federation">Apollo Federation</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Monitoring</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/0.24/open-telemetry">OpenTelemetry</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/open-tracing">OpenTracing</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/apollo-tracing">Apollo Tracing</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Security</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/0.24/security-overview">Security Overview</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/hiding-field-suggestions">Hiding field suggestions</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/disabling-stack-traces">Disabling stack traces</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/continuous-security-testing">Continuous security testing</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Servers</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/0.24/asgi">ASGI application</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/wsgi">WSGI application</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/aws-lambda">AWS Lambda</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Integrations</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/0.24/django-integration">Django</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/fastapi-integration">FastAPI</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/flask-integration">Flask</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/starlette-integration">Starlette</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/other-integrations">Other technologies</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Extensions</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/0.24/extensions">Extension system</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/middleware">Middleware</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/query-validators">Query validators</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/query-stack">Customizing Query Stack</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">API reference</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/0.24/api-reference">ariadne</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/asgi-reference">ariadne.asgi</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/asgi-handlers-reference">ariadne.asgi.handlers</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/constants-reference">ariadne.constants</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/exceptions-reference">ariadne.exceptions</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/types-reference">ariadne.types</a></li><li class="navListItem"><a class="navItem" href="/docs/0.24/wsgi-reference">ariadne.wsgi</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Other</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/0.24/logo">Ariadne logo</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              const headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                if (event.target.tagName === 'A') {
                  document.body.classList.remove('tocActive');
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Dataloaders</h1></header><article><div><span><p>Dataloaders are a GraphQL pattern for solving the N+1 problem, where retrieval of <strong>N number of items</strong> results in <strong>N + 1 number of data retrieval operations</strong>.</p>
<h2><a class="anchor" aria-hidden="true" id="the-n-1-problem"></a><a href="#the-n-1-problem" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>The &quot;N+1&quot; problem</h2>
<p>Let's take the GraphQL schema modeling a simple relation where messages have users who posted them:</p>
<pre><code class="hljs css language-graphql"><span class="token keyword">type</span> <span class="token class-name">Query</span> <span class="token punctuation">{</span>
    <span class="token attr-name">messages</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>Message<span class="token operator">!</span><span class="token punctuation">]</span><span class="token operator">!</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> <span class="token class-name">Message</span> <span class="token punctuation">{</span>
    <span class="token attr-name">id</span><span class="token punctuation">:</span> ID<span class="token operator">!</span>
    <span class="token attr-name">message</span><span class="token punctuation">:</span> String<span class="token operator">!</span>
    <span class="token attr-name">poster</span><span class="token punctuation">:</span> User
<span class="token punctuation">}</span>

<span class="token keyword">type</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    <span class="token attr-name">id</span><span class="token punctuation">:</span> ID<span class="token operator">!</span>
    <span class="token attr-name">name</span><span class="token punctuation">:</span> String<span class="token operator">!</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Resolver for <code>messages</code> field selects messages from database ordered by their id in reverse order:</p>
<pre><code class="hljs css language-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">resolve_query_messages</span><span class="hljs-params">(*_)</span>:</span>
    <span class="hljs-keyword">return</span> db_fetch_all(
        <span class="hljs-string">"SELECT id, poster_id, message FROM messages ORDER BY id DESC"</span>
    )
</code></pre>
<p>Resolver for <code>poster</code> field checks if message has id of a user who posted it, and if it does, retrieves this user from the database:</p>
<pre><code class="hljs css language-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">resolve_message_poster</span><span class="hljs-params">(message, *_)</span>:</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> message[<span class="hljs-string">"poster_id"</span>]:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>  <span class="hljs-comment"># Skip database query when message has no poster</span>

    <span class="hljs-keyword">return</span> db_fetch_one(
        <span class="hljs-string">"SELECT id, name FROM users WHERE id = %s"</span>, message[<span class="hljs-string">"poster_id"</span>]
    )
</code></pre>
<p>Assuming that there are <strong>20 rows</strong> in <code>messages</code> table in database, this GraphQL query will <strong>cause 21 database queries</strong>:</p>
<pre><code class="hljs css language-graphql"><span class="token keyword">query</span> SelectMessages <span class="token punctuation">{</span>
    messages <span class="token punctuation">{</span>
        id
        message
        poster <span class="token punctuation">{</span>
            id
            name
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>There's 1 database query for messages which returns 20 rows, each row causing one extra database query:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span>, poster_id, message <span class="hljs-keyword">FROM</span> messages <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">id</span> <span class="hljs-keyword">DESC</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">39</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">31</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">39</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">96</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">19</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">63</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">32</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">34</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">48</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">12</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">12</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">12</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">41</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">98</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">19</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">42</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">46</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">31</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">48</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">id</span>, <span class="hljs-keyword">name</span> <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">users</span> <span class="hljs-keyword">WHERE</span> <span class="hljs-keyword">id</span> = <span class="hljs-number">92</span>;
</code></pre>
<p>20 rows is our <code>N</code>, and extra query is <code>+1</code>. This is the famous &quot;N+1&quot; problem in action.</p>
<h2><a class="anchor" aria-hidden="true" id="half-measures"></a><a href="#half-measures" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Half-measures</h2>
<p>There are some solutions to this problem that can be implemented quickly, but have their own drawbacks.</p>
<p>For example, we can update <code>messages</code> resolver to use database <code>JOIN</code> operation, thus retrieving messages together with their posters:</p>
<pre><code class="hljs css language-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">resolve_query_messages</span><span class="hljs-params">(*_)</span>:</span>
    <span class="hljs-keyword">return</span> db_fetch_all(
        <span class="hljs-string">"""
        SELECT m.id, m.poster_id, m.message, u.id AS u_id, u.name AS u_name
        FROM messages AS m
        LEFT JOIN users AS u ON m.poster_id = u.id;
        ORDER BY m.id DESC
        """</span>
    )
</code></pre>
<p>Now we can update <code>poster</code> resolver to pull user's data from result:</p>
<pre><code class="hljs css language-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">resolve_message_poster</span><span class="hljs-params">(message, *_)</span>:</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> message[<span class="hljs-string">"u_id"</span>]:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>  <span class="hljs-comment"># Skip when message has no poster</span>

    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"id"</span>: message[<span class="hljs-string">"u_id"</span>],
        <span class="hljs-string">"name"</span>: message[<span class="hljs-string">"u_name"</span>],
    }
</code></pre>
<p>This change is enough to fix the issue. If we are using an ORM, it may not even require <code>resolve_message_poster</code> resolver to exist at all because <code>message</code> object will have <code>poster</code> attribute populated by the joined value.</p>
<p><strong>But</strong> if GraphQL query doesn't include the <code>poster</code> field, we now potentially spend a lot of extra work and memory retrieving data we won't use. This is the overfetching problem that GraphQL is supposed to solve, even if this time its limited to server only.</p>
<p>What if instead of database we are using remote API? We will still need to run two API calls:</p>
<pre><code class="hljs css language-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">resolve_query_messages</span><span class="hljs-params">(*_)</span>:</span>
    messages = client.get(<span class="hljs-string">"http://api.example.com/messages/"</span>)

    posters = {
        message[<span class="hljs-string">"poster_id"</span>]: <span class="hljs-literal">None</span>
        <span class="hljs-keyword">for</span> message <span class="hljs-keyword">in</span> messages <span class="hljs-keyword">if</span> message[<span class="hljs-string">"poster_id"</span>]
    }

    <span class="hljs-keyword">if</span> posters:
        api_qs = <span class="hljs-string">"&amp;"</span>.join(<span class="hljs-string">f"id=<span class="hljs-subst">{uid}</span>"</span> <span class="hljs-keyword">for</span> uid <span class="hljs-keyword">in</span> posters)
        api_url = <span class="hljs-string">f"http://api.example.com/users/?<span class="hljs-subst">{api_qs}</span>"</span>

        <span class="hljs-keyword">for</span> poster <span class="hljs-keyword">in</span> client.get(api_url):
            posters[poster[<span class="hljs-string">"id"</span>]] = poster

        <span class="hljs-keyword">for</span> message <span class="hljs-keyword">in</span> messages:
            message[<span class="hljs-string">"poster"</span>] = posters.get(message[<span class="hljs-string">"poster_id"</span>])

    <span class="hljs-keyword">return</span> messages
</code></pre>
<p>There's quite a lot of extra logic. What if there are more lists of items that have relation to <code>user</code>? Most likely we will now have an util for our resolvers to fetch their users:</p>
<pre><code class="hljs css language-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_users_from_api</span><span class="hljs-params">(users_ids: list[int])</span> -&gt; dict[int, dict]:</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> users_ids:
        <span class="hljs-keyword">return</span> {}

    api_values = <span class="hljs-string">"&amp;"</span>.join(<span class="hljs-string">f"id=<span class="hljs-subst">{uid}</span>"</span> <span class="hljs-keyword">for</span> uid <span class="hljs-keyword">in</span> users_ids)
    api_url = <span class="hljs-string">f"http://api.example.com/users/?<span class="hljs-subst">{api_values}</span>"</span>

    <span class="hljs-keyword">return</span> {user[<span class="hljs-string">"id"</span>]: user <span class="hljs-keyword">for</span> user <span class="hljs-keyword">in</span> client.get(api_url)}
</code></pre>
<p>We are now a <strong>half</strong>-way to implementing a dataloader. üëè</p>
<h2><a class="anchor" aria-hidden="true" id="dataloader"></a><a href="#dataloader" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Dataloader</h2>
<p>Dataloader is a proxy to a data source. What this data source is doesn't matter. For performance reasons its important that this source supports bulk retrieval of items, but thats not required.</p>
<p>Dataloader <strong>knows</strong> how to retrieve required objects in most optimal way.</p>
<p>Dataloader <strong>batches</strong> multiple retrieval operations into one.</p>
<p>Dataloader <strong>may</strong> cache retrieved items to make repeated retrievals faster.</p>
<p>In short, dataloader is <strong>magic</strong>:</p>
<pre><code class="hljs css language-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_user</span><span class="hljs-params">(user_id: int)</span> -&gt; Optional[dict]:</span>
    <span class="hljs-comment"># üåü magic üåü</span>


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">resolve_message_poster</span><span class="hljs-params">(message, *_)</span>:</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> message[<span class="hljs-string">"poster_id"</span>]:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>  <span class="hljs-comment"># Skip when message has no poster</span>

    <span class="hljs-keyword">return</span> load_user(message[<span class="hljs-string">"poster_id"</span>])
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="async-dataloader"></a><a href="#async-dataloader" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Async dataloader</h2>
<p>If you are using <code>async</code> approach (eg. <code>ariadne.graphql</code> or <code>ariadne.asgi.GraphQL</code>), use <a href="https://github.com/syrusakbary/aiodataloader"><code>aiodataloader</code></a>:</p>
<pre><code class="hljs">$ pip <span class="hljs-keyword">install</span> aiodataloader
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="loader-function"></a><a href="#loader-function" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Loader function</h3>
<p>After installing <code>aiodataloader</code>, we will need to first define function it will use to load data.</p>
<p><code>aiodataloader</code> requires those functions to take single argument (list of IDs of objects to retrieve), and return a list with retrieved objects, in the order of ids it was called with, with items that couldn't be found represented as <code>None</code>.</p>
<p>In this example we will continue using the <code>get_users_from_api</code> function, but we need to make some changes to it first.</p>
<pre><code class="hljs css language-python"><span class="hljs-keyword">from</span> httpx <span class="hljs-keyword">import</span> AsyncClient

<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_users_from_api</span><span class="hljs-params">(users_ids: list[int])</span> -&gt; list[dict]:</span>
    <span class="hljs-comment"># Build API URL</span>
    api_values = <span class="hljs-string">"&amp;"</span>.join(<span class="hljs-string">f"id=<span class="hljs-subst">{uid}</span>"</span> <span class="hljs-keyword">for</span> uid <span class="hljs-keyword">in</span> users_ids)
    api_url = <span class="hljs-string">f"http://api.example.com/users/?<span class="hljs-subst">{api_values}</span>"</span>

    <span class="hljs-comment"># Fetch users from API</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> AsyncClient() <span class="hljs-keyword">as</span> client:
        ids_map = {user[<span class="hljs-string">"id"</span>]: user <span class="hljs-keyword">for</span> user <span class="hljs-keyword">in</span> <span class="hljs-keyword">await</span> client.get(api_url)}

    <span class="hljs-comment"># Return user as list using same order as users_ids passed to function</span>
    <span class="hljs-comment"># Replace result with none when user with given id was not returned</span>
    <span class="hljs-keyword">return</span> [ids_map.get(uid) <span class="hljs-keyword">for</span> uid <span class="hljs-keyword">in</span> users_ids]
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="initializing-loader-in-context"></a><a href="#initializing-loader-in-context" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Initializing loader in context</h3>
<p>We now need to store instance of <code>aiodataloader.DataLoader</code> with our function in a place that's bound to HTTP request but also accessible by our GraphQL resolvers. GraphQL <code>context</code> was created exactly for this case:</p>
<pre><code class="hljs css language-python"><span class="hljs-keyword">from</span> aiodataloader <span class="hljs-keyword">import</span> DataLoader
<span class="hljs-keyword">from</span> ariadne.asgi <span class="hljs-keyword">import</span> GraphQL
<span class="hljs-keyword">from</span> httpx <span class="hljs-keyword">import</span> AsyncClient
<span class="hljs-keyword">from</span> starlette.requests <span class="hljs-keyword">import</span> Request

<span class="hljs-keyword">from</span> .schema <span class="hljs-keyword">import</span> schema


<span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_users_from_api</span><span class="hljs-params">(users_ids: list[int])</span> -&gt; list[dict]:</span>
    <span class="hljs-comment"># Build API URL</span>
    api_values = <span class="hljs-string">"&amp;"</span>.join(<span class="hljs-string">f"id=<span class="hljs-subst">{uid}</span>"</span> <span class="hljs-keyword">for</span> uid <span class="hljs-keyword">in</span> users_ids)
    api_url = <span class="hljs-string">f"http://api.example.com/users/?<span class="hljs-subst">{api_values}</span>"</span>

    <span class="hljs-comment"># Fetch users from API</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> AsyncClient() <span class="hljs-keyword">as</span> client:
        ids_map = {user[<span class="hljs-string">"id"</span>]: user <span class="hljs-keyword">for</span> user <span class="hljs-keyword">in</span> <span class="hljs-keyword">await</span> client.get(api_url)}

    <span class="hljs-comment"># Return user as list using same order as users_ids passed to function</span>
    <span class="hljs-comment"># Replace result with none when user with given id was not returned</span>
    <span class="hljs-keyword">return</span> [ids_map.get(uid) <span class="hljs-keyword">for</span> uid <span class="hljs-keyword">in</span> users_ids]


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_context_value</span><span class="hljs-params">(request: Request)</span>:</span>
    <span class="hljs-comment"># Context value function will be called for every request to GraphQL server</span>
    <span class="hljs-comment"># Its retrievable as `context` attribute of resolver's second argument</span>
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"request"</span>: request,
        <span class="hljs-string">"user_loader"</span>: DataLoader(get_users_from_api)
    }

asgi_app = GraphQL(schema, context_value=get_context_value)
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="using-loader-in-resolvers"></a><a href="#using-loader-in-resolvers" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using loader in resolvers</h3>
<p>We can now update our <code>poster</code> resolver to use the loader:</p>
<pre><code class="hljs css language-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">resolve_message_poster</span><span class="hljs-params">(message, info)</span>:</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> message[<span class="hljs-string">"u_id"</span>]:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>  <span class="hljs-comment"># Skip when message has no poster</span>

    <span class="hljs-keyword">return</span> info.context[<span class="hljs-string">"user_loader"</span>].load(message[<span class="hljs-string">"u_id"</span>])
</code></pre>
<p><code>DataLoader.load()</code> takes id of an object to load, and returns awaitable for this object or <code>None</code> (when it could not be loaded). GraphQL resolvers can be <code>async</code>, but can also just return awaitable values. Below resolver behaves the same as previous one during GraphQL query execution:</p>
<pre><code class="hljs css language-python"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">resolve_message_poster</span><span class="hljs-params">(message, info)</span>:</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> message[<span class="hljs-string">"u_id"</span>]:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>  <span class="hljs-comment"># Skip when message has no poster</span>

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> info.context[<span class="hljs-string">"user_loader"</span>].load(message[<span class="hljs-string">"u_id"</span>])
</code></pre>
<p>It doesn't matter which approach you use, but if you want to do something with loaded value before returning it from resolver, you will need <code>async</code> resolver that awaits it before returning it:</p>
<pre><code class="hljs css language-python"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">resolve_message_poster</span><span class="hljs-params">(message, info)</span>:</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> message[<span class="hljs-string">"u_id"</span>]:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>  <span class="hljs-comment"># Skip when message has no poster</span>

    user = <span class="hljs-keyword">await</span> info.context[<span class="hljs-string">"user_loader"</span>].load(message[<span class="hljs-string">"u_id"</span>])

    <span class="hljs-comment"># Test if loaded user was banned and don't return them if so</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user <span class="hljs-keyword">or</span> user.is_banned:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

    <span class="hljs-keyword">return</span> user
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="cache"></a><a href="#cache" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cache</h3>
<p><code>DataLoader</code> caches previously loaded objects on it's instance, so repeated calls to <code>load</code> previously loaded objects don't trigger new loads.</p>
<p>This cache can become stale in situations when mutation resolver changes application state. If this happens you can manually remove the object from cache using <code>clear(key)</code> method, or clear entire cache with <code>clear_all</code> method:</p>
<pre><code class="hljs css language-python"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">resolve_move_category_contents</span><span class="hljs-params">(_, info, **kwargs)</span>:</span>
    <span class="hljs-comment"># ... logic doing something with category</span>

    <span class="hljs-comment"># Remove category from categories dataloder</span>
    info.context[<span class="hljs-string">"categories_loader"</span>].clear(category.id)

    <span class="hljs-comment"># Clear threads and posts dataloaders cache because their category_id</span>
    <span class="hljs-comment"># attributes are no longer valid and can cause problem in other resolvers</span>
    info.context[<span class="hljs-string">"thread_loader"</span>].clear_all()
    info.context[<span class="hljs-string">"post_loader"</span>].clear_all()

    <span class="hljs-keyword">return</span> {<span class="hljs-string">"success"</span>: <span class="hljs-literal">True</span>}
</code></pre>
<p>You can also put object in the cache without loading it using <code>prime</code> method:</p>
<pre><code class="hljs css language-python"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">resolve_register_user_account</span><span class="hljs-params">(_, info, **kwargs)</span>:</span>
    <span class="hljs-comment"># ... logic validating and registering `user` account</span>

    <span class="hljs-comment"># Store user in dataloader in case it will be used by other resolvers</span>
    <span class="hljs-comment"># during this GraphQL query</span>
    info.context[<span class="hljs-string">"user_loader"</span>].prime(user.id, user)

    <span class="hljs-keyword">return</span> {<span class="hljs-string">"user"</span>: user}
</code></pre>
<p>Initialize the <code>DataLoader</code> with <code>cache=False</code> to disable caching:</p>
<pre><code class="hljs css language-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_context_value</span><span class="hljs-params">(request: Request)</span>:</span>
    <span class="hljs-comment"># Context value function will be called for every request to GraphQL server</span>
    <span class="hljs-comment"># Its retrievable as `context` attribute of resolver's second argument</span>
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"request"</span>: request,
        <span class="hljs-string">"user_loader"</span>: DataLoader(get_users_from_api, cache=<span class="hljs-literal">False</span>)
    }
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="sync-dataloader"></a><a href="#sync-dataloader" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Sync dataloader</h2>
<p>If you are using sync approach, use <a href="https://github.com/jkimbo/graphql-sync-dataloaders"><code>graphql-sync-dataloaders</code></a> (Python 3.8 and later only):</p>
<pre><code class="hljs">$ pip <span class="hljs-keyword">install </span>graphql-<span class="hljs-keyword">sync-dataloaders
</span></code></pre>
<h3><a class="anchor" aria-hidden="true" id="loader-function-1"></a><a href="#loader-function-1" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Loader function</h3>
<p>After installing <code>graphql-sync-dataloaders</code>, we will need to first define function it will use to load data.</p>
<p><code>graphql-sync-dataloaders</code> requires those functions to take single argument (list of IDs of objects to retrieve), and return a list with retrieved objects, in the order of ids it was called with, with items that couldn't be found represented as <code>None</code>.</p>
<p>In this example we will continue using the <code>get_users_from_api</code> function, but we need to make some changes to it first.</p>
<pre><code class="hljs css language-python"><span class="hljs-keyword">import</span> httpx

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_users_from_api</span><span class="hljs-params">(users_ids: list[int])</span> -&gt; list[dict]:</span>
    <span class="hljs-comment"># Build API URL</span>
    api_values = <span class="hljs-string">"&amp;"</span>.join(<span class="hljs-string">f"id=<span class="hljs-subst">{uid}</span>"</span> <span class="hljs-keyword">for</span> uid <span class="hljs-keyword">in</span> users_ids)
    api_url = <span class="hljs-string">f"http://api.example.com/users/?<span class="hljs-subst">{api_values}</span>"</span>

    <span class="hljs-comment"># Fetch users from API</span>
    ids_map = {user[<span class="hljs-string">"id"</span>]: user <span class="hljs-keyword">for</span> user <span class="hljs-keyword">in</span> httpx.get(api_url)}

    <span class="hljs-comment"># Return user as list using same order as users_ids passed to function</span>
    <span class="hljs-comment"># Replace result with none when user with given id was not returned</span>
    <span class="hljs-keyword">return</span> [ids_map.get(uid) <span class="hljs-keyword">for</span> uid <span class="hljs-keyword">in</span> users_ids]
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="initializing-loader-in-context-1"></a><a href="#initializing-loader-in-context-1" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Initializing loader in context</h3>
<p>We now need to store instance of <code>graphql_sync_dataloaders.SyncDataLoader</code> with our function in a place that's bound to HTTP request but also accessible by our GraphQL resolvers. We will use GraphQL <code>context</code> for this case, but we also need to set custom <code>DeferredExecutionContext</code> GraphQL execution context class which knows about our dataloader.</p>
<p>Here's example Flask application:</p>
<pre><code class="hljs css language-python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">from</span> graphql_sync_dataloaders <span class="hljs-keyword">import</span> DeferredExecutionContext, SyncDataLoader
<span class="hljs-keyword">from</span> ariadne <span class="hljs-keyword">import</span> graphql_sync
<span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, jsonify, request

<span class="hljs-keyword">from</span> .schema <span class="hljs-keyword">import</span> schema


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_users_from_api</span><span class="hljs-params">(users_ids: list[int])</span> -&gt; list[dict]:</span>
    <span class="hljs-comment"># Build API URL</span>
    api_values = <span class="hljs-string">"&amp;"</span>.join(<span class="hljs-string">f"id=<span class="hljs-subst">{uid}</span>"</span> <span class="hljs-keyword">for</span> uid <span class="hljs-keyword">in</span> users_ids)
    api_url = <span class="hljs-string">f"http://api.example.com/users/?<span class="hljs-subst">{api_values}</span>"</span>

    <span class="hljs-comment"># Fetch users from API</span>
    ids_map = {user[<span class="hljs-string">"id"</span>]: user <span class="hljs-keyword">for</span> user <span class="hljs-keyword">in</span> httpx.get(api_url)}

    <span class="hljs-comment"># Return user as list using same order as users_ids passed to function</span>
    <span class="hljs-comment"># Replace result with none when user with given id was not returned</span>
    <span class="hljs-keyword">return</span> [ids_map.get(uid) <span class="hljs-keyword">for</span> uid <span class="hljs-keyword">in</span> users_ids]


app = Flask(__name__)


<span class="hljs-meta">@app.route("/graphql", methods=["POST"])</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">graphql_server</span><span class="hljs-params">()</span>:</span>
    data = request.get_json()

    success, result = graphql_sync(
        schema,
        data,
        <span class="hljs-comment"># Context value with dataloader available as `user_loader`</span>
        context_value={
            <span class="hljs-string">"request"</span>: request,
            <span class="hljs-string">"user_loader"</span>: SyncDataLoader(get_users_from_api),
        },
        <span class="hljs-comment"># Use DeferredExecutionContext as custom execution context</span>
        execution_context_class=DeferredExecutionContext,
    )

    status_code = <span class="hljs-number">200</span> <span class="hljs-keyword">if</span> success <span class="hljs-keyword">else</span> <span class="hljs-number">400</span>
    <span class="hljs-keyword">return</span> jsonify(result), status_code


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    app.run(debug=<span class="hljs-literal">True</span>)
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="using-loader-in-resolvers-1"></a><a href="#using-loader-in-resolvers-1" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using loader in resolvers</h3>
<p>We can now update our <code>poster</code> resolver to use the loader:</p>
<pre><code class="hljs css language-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">resolve_message_poster</span><span class="hljs-params">(message, info)</span>:</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> message[<span class="hljs-string">"u_id"</span>]:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>  <span class="hljs-comment"># Skip when message has no poster</span>

    <span class="hljs-keyword">return</span> info.context[<span class="hljs-string">"user_loader"</span>].load(message[<span class="hljs-string">"u_id"</span>])
</code></pre>
<p><code>SyncDataLoader.load()</code> takes id of an object to load, and returns <code>SyncFuture</code> for this object or <code>None</code> (when it could not be loaded). <code>DeferredExecutionContext</code> then knows how to gather <code>SyncFuture</code> returned by multiple resolver calls, then batch load and replace them with their results.</p>
<p>If you want to do something with loaded object before returning it, you need to do it in a callback passed to it with <code>then</code> method:</p>
<pre><code class="hljs css language-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">resolve_message_poster</span><span class="hljs-params">(message, info)</span>:</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> message[<span class="hljs-string">"u_id"</span>]:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>  <span class="hljs-comment"># Skip when message has no poster</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">return_user_if_not_banned</span><span class="hljs-params">(user)</span>:</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> user <span class="hljs-keyword">or</span> user.is_banned:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

        <span class="hljs-keyword">return</span> user

    <span class="hljs-keyword">return</span> info.context[<span class="hljs-string">"user_loader"</span>].load(
        message[<span class="hljs-string">"u_id"</span>]
    ).then(
        return_user_if_not_banned
    )
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="cache-1"></a><a href="#cache-1" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Cache</h3>
<p><code>SyncDataLoader</code> caches previously loaded objects on it's instance, so repeated calls to <code>load</code> previously loaded objects don't trigger new loads.</p>
<p>This cache can become stale in situations when mutation resolver changes application state. If this happens you can manually remove the object from cache using <code>clear(key)</code>:</p>
<pre><code class="hljs css language-python"><span class="hljs-keyword">async</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">resolve_move_category_contents</span><span class="hljs-params">(_, info, **kwargs)</span>:</span>
    <span class="hljs-comment"># ... logic doing something with category</span>

    <span class="hljs-comment"># Remove category from categories dataloder</span>
    info.context[<span class="hljs-string">"categories_loader"</span>].clear(category.id)

    <span class="hljs-keyword">return</span> {<span class="hljs-string">"success"</span>: <span class="hljs-literal">True</span>}
</code></pre>
<p>Unlike <code>DataLoader</code>, <code>SyncDataLoader</code> doesn't provide an API for clearing entire cache or priming objects.</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/0.24/subscriptions"><span class="arrow-prev">‚Üê </span><span>Subscriptions</span></a><a class="docs-next button" href="/docs/0.24/file-uploads"><span>File uploads</span><span class="arrow-next"> ‚Üí</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#the-n-1-problem">The &quot;N+1&quot; problem</a></li><li><a href="#half-measures">Half-measures</a></li><li><a href="#dataloader">Dataloader</a></li><li><a href="#async-dataloader">Async dataloader</a><ul class="toc-headings"><li><a href="#loader-function">Loader function</a></li><li><a href="#initializing-loader-in-context">Initializing loader in context</a></li><li><a href="#using-loader-in-resolvers">Using loader in resolvers</a></li><li><a href="#cache">Cache</a></li></ul></li><li><a href="#sync-dataloader">Sync dataloader</a><ul class="toc-headings"><li><a href="#loader-function-1">Loader function</a></li><li><a href="#initializing-loader-in-context-1">Initializing loader in context</a></li><li><a href="#using-loader-in-resolvers-1">Using loader in resolvers</a></li><li><a href="#cache-1">Cache</a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/icon.png" alt="Ariadne" height="107" width="128"/></a><div class="footerNavSpacer"></div><div class="footerNavTwoColumn"><h5>Documentation</h5><a href="/docs/intro.html">Introduction</a><a href="/docs/resolvers.html">Resolvers</a><a href="/docs/mutations.html">Mutations</a><a href="/docs/subscriptions.html">Subscriptions</a><a href="/docs/django-integration.html">Django integration</a><a href="/docs/flask-integration.html">Flask integration</a><a href="/docs/starlette-integration.html">Starlette integration</a><a href="/docs/other-integrations.html">Other integrations</a><a href="/docs/api-reference.html">API Reference</a><a href="/docs/logo.html">Logo</a></div><div><h5>Community</h5><a href="https://github.com/mirumee/ariadne/discussions/">Discuss</a><a href="https://github.com/mirumee/ariadne">GitHub</a><a class="github-button" href="https://github.com/mirumee/ariadne" data-icon="octicon-star" data-count-href="/mirumee/ariadne/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a></div></section><section class="copyright"><a href="https://mirumee.com">Copyright ¬© 2025 Mirumee Software</a><a href="https://mirumee.com">Ariadne is crafted with love by<img src="/img/mirumee.png" alt="Mirumee"/></a></section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>window.twttr=(function(d,s, id){var js,fjs=d.getElementsByTagName(s)[0],t=window.twttr||{};if(d.getElementById(id))return t;js=d.createElement(s);js.id=id;js.src='https://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js, fjs);t._e = [];t.ready = function(f) {t._e.push(f);};return t;}(document, 'script', 'twitter-wjs'));</script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: '507581234da84aebc8fe9918f530b714',
                indexName: 'ariadnegraphql',
                inputSelector: '#search_input_react'
              });
            </script></body></html>